name: Build Executables - All Platforms

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      version:
        description: "Version number (e.g., 1.0.0)"
        required: false
        default: "1.0.0"

env:
  PYTHON_VERSION: "3.12"

jobs:
  # ========================================================================
  # LINUX BUILD
  # ========================================================================
  build-linux:
    name: Build Linux (.deb + executable)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: |
          sudo apt-get update
          sudo apt-get install -y binutils upx-ucl dpkg-dev

      - run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - run: python -m PyInstaller essl-agent.spec --clean

      - run: strip dist/essl-agent/essl-agent || true

      - run: |
          VERSION="${{ github.event.inputs.version || '1.0.0' }}"
          PACKAGE_NAME="essl-agent"
          DEB_DIR="deb_build/${PACKAGE_NAME}_${VERSION}"

          mkdir -p "${DEB_DIR}/DEBIAN"
          mkdir -p "${DEB_DIR}/opt/${PACKAGE_NAME}"
          mkdir -p "${DEB_DIR}/etc/${PACKAGE_NAME}"
          mkdir -p "${DEB_DIR}/lib/systemd/system"
          mkdir -p "${DEB_DIR}/usr/share/doc/${PACKAGE_NAME}"

          cp -r dist/essl-agent/* "${DEB_DIR}/opt/${PACKAGE_NAME}/"

          cat > "${DEB_DIR}/etc/${PACKAGE_NAME}/config.env" << 'EOF'
          SERVER_URL=http://your-server-url.com
          AGENT_ID=your-agent-id
          EOF

          cat > "${DEB_DIR}/DEBIAN/control" << EOF
          Package: ${PACKAGE_NAME}
          Version: ${VERSION}
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: Your Company <support@yourcompany.com>
          Description: ESSL Agent - Biometric Device Management
          EOF

          cat > "${DEB_DIR}/DEBIAN/postinst" << 'EOF'
          #!/bin/bash
          ln -sf /etc/essl-agent/config.env /opt/essl-agent/.env
          chmod +x /opt/essl-agent/essl-agent
          systemctl daemon-reload || true
          exit 0
          EOF
          chmod +x "${DEB_DIR}/DEBIAN/postinst"

          dpkg-deb --build "${DEB_DIR}"

          mkdir -p artifacts
          mv "deb_build/${PACKAGE_NAME}_${VERSION}.deb" artifacts/
          cp -r dist/essl-agent artifacts/essl-agent-linux

      - uses: actions/upload-artifact@v4
        with:
          name: essl-agent-deb
          path: artifacts/*.deb

      - uses: actions/upload-artifact@v4
        with:
          name: essl-agent-linux
          path: artifacts/essl-agent-linux

  # ========================================================================
  # WINDOWS BUILD
  # ========================================================================
  build-windows:
    name: Build Windows (.exe)
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - run: python -m PyInstaller essl-agent.spec --clean

      - run: |
          mkdir artifacts
          xcopy dist\essl-agent artifacts\essl-agent-windows\ /E /I /Y
        shell: cmd

      - uses: actions/upload-artifact@v4
        with:
          name: essl-agent-windows
          path: artifacts/essl-agent-windows

  # ========================================================================
  # MACOS BUILD
  # ========================================================================
  build-macos:
    name: Build macOS
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - run: python -m PyInstaller essl-agent.spec --clean

      - run: strip dist/essl-agent/essl-agent || true

      - run: |
          mkdir -p artifacts
          cp -r dist/essl-agent artifacts/essl-agent-macos

      - uses: actions/upload-artifact@v4
        with:
          name: essl-agent-macos
          path: artifacts/essl-agent-macos

  # ========================================================================
  # RELEASE + S3 UPLOAD
  # ========================================================================
  create-release:
    name: Create Release + Upload to S3
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest

    # ðŸ”¥ FIXED: Run if tag OR manual trigger
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/download-artifact@v4

      - name: Extract Version
        id: version
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          fi

      - uses: softprops/action-gh-release@v1
        with:
          files: |
            essl-agent-deb/*.deb
            essl-agent-linux/**/*
            essl-agent-windows/**/*
            essl-agent-macos/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ---------- S3 UPLOAD ----------
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-1

      - name: Upload artifacts to S3
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          aws s3 cp essl-agent-linux/ s3://stock-management-system/essl-agent/$VERSION/linux/ --recursive
          aws s3 cp essl-agent-windows/ s3://stock-management-system/essl-agent/$VERSION/windows/ --recursive
          aws s3 cp essl-agent-macos/ s3://stock-management-system/essl-agent/$VERSION/macos/ --recursive
          aws s3 cp essl-agent-deb/ s3://stock-management-system/essl-agent/$VERSION/deb/ --recursive
